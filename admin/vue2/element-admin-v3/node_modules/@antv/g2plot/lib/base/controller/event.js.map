{"version":3,"file":"event.js","sourceRoot":"","sources":["../../../src/base/controller/event.ts"],"names":[],"mappings":";;AAAA,mCAA0D;AA4B1D,SAAS,WAAW,CAAC,MAAc,EAAE,MAAc;IACjD,IAAI,MAAM,IAAI,MAAM,IAAI,MAAM,KAAK,MAAM,EAAE;QACzC,OAAO,IAAI,CAAC;KACb;IACD,OAAO,KAAK,CAAC;AACf,CAAC;AAED,SAAS,aAAa,CAAC,KAAY,EAAE,IAAU;IAC7C,IAAI,KAAK,CAAC,CAAC,IAAI,IAAI,CAAC,IAAI,IAAI,KAAK,CAAC,CAAC,IAAI,IAAI,CAAC,IAAI,IAAI,KAAK,CAAC,CAAC,IAAI,IAAI,CAAC,IAAI,IAAI,KAAK,CAAC,CAAC,IAAI,IAAI,CAAC,IAAI,EAAE;QAChG,OAAO,IAAI,CAAC;KACb;IACD,OAAO,KAAK,CAAC;AACf,CAAC;AAED;IAME,yBAAY,GAAqB;QAC/B,IAAI,CAAC,IAAI,GAAG,GAAG,CAAC,IAAI,CAAC;QACrB,IAAI,CAAC,MAAM,GAAG,GAAG,CAAC,MAAM,CAAC;QACzB,IAAI,CAAC,aAAa,GAAG,EAAE,CAAC;IAC1B,CAAC;IAEM,oCAAU,GAAjB;QACE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,EAAE,WAAW,EAAE,mBAAY,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC,CAAC;QACxE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,EAAE,WAAW,EAAE,mBAAY,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC,CAAC;QACtE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,EAAE,SAAS,EAAE,mBAAY,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC,CAAC;QACtE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,EAAE,OAAO,EAAE,mBAAY,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC,CAAC;QACpE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,EAAE,UAAU,EAAE,mBAAY,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC,CAAC;QACvE,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,EAAE,aAAa,EAAE,mBAAY,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC,CAAC;QAC1E,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,EAAE,OAAO,EAAE,mBAAY,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC,CAAC;IACtE,CAAC;IAEM,qCAAW,GAAlB;QACE,IAAM,aAAa,GAAG,IAAI,CAAC,aAAa,CAAC;QACzC,WAAI,CAAC,aAAa,EAAE,UAAC,EAAE;YACrB,EAAE,CAAC,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,IAAI,EAAE,EAAE,CAAC,OAAO,CAAC,CAAC;QACrC,CAAC,CAAC,CAAC;IACL,CAAC;IAEO,kCAAQ,GAAhB,UAAiB,MAAe,EAAE,SAAiB,EAAE,OAAiB;QACpE,MAAM,CAAC,EAAE,CAAC,SAAS,EAAE,OAAO,CAAC,CAAC;QAC9B,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,EAAE,MAAM,QAAA,EAAE,IAAI,EAAE,SAAS,EAAE,OAAO,SAAA,EAAE,CAAC,CAAC;IAChE,CAAC;IAEO,kCAAQ,GAAhB,UAAiB,EAAE;QACjB,IAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC;QACtC,IAAM,MAAM,GAAQ,EAAE,CAAC,MAAM,CAAC;QAC9B,sBAAsB;QACtB,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,IAAI,MAAM,CAAC,IAAI,EAAE;YAC9C,IAAI,CAAC,IAAI,CAAC,IAAI,CAAI,MAAM,CAAC,IAAI,SAAI,EAAE,CAAC,IAAM,EAAE,EAAE,CAAC,CAAC;SACjD;QACD,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,KAAG,EAAE,CAAC,IAAM,EAAE,QAAQ,CAAC,CAAC;QACvC,UAAU;QACV,IAAM,MAAM,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC;QACrC,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE;YACrB,IAAI,CAAC,YAAY,CAAC,MAAM,EAAE,QAAQ,EAAE,EAAE,CAAC,IAAI,CAAC,CAAC;SAC9C;IACH,CAAC;IAEO,gCAAM,GAAd,UAAe,EAAE;QACf,IAAM,MAAM,GAAQ,EAAE,CAAC,MAAM,CAAC;QAC9B,IAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,EAAE,CAAC,CAAC;QACtC,2CAA2C;QAC3C,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,MAAM,CAAC,IAAI,MAAM,CAAC,IAAI,EAAE;YAC9C,IAAI,CAAC,IAAI,CAAC,IAAI,CAAI,MAAM,CAAC,IAAI,SAAI,EAAE,CAAC,IAAM,EAAE,QAAQ,CAAC,CAAC;YACtD,0BAA0B;YAC1B,IAAI,IAAI,CAAC,SAAS,IAAI,CAAC,WAAW,CAAC,MAAM,EAAE,IAAI,CAAC,SAAS,CAAC,EAAE;gBAC1D,IAAI,IAAI,CAAC,SAAS,EAAE;oBAClB,IAAI,CAAC,IAAI,CAAC,IAAI,CAAI,IAAI,CAAC,SAAS,CAAC,IAAI,gBAAa,EAAE,QAAQ,CAAC,CAAC;iBAC/D;gBACD,IAAI,CAAC,IAAI,CAAC,IAAI,CAAI,MAAM,CAAC,IAAI,gBAAa,EAAE,QAAQ,CAAC,CAAC;aACvD;YACD,IAAI,CAAC,SAAS,GAAG,MAAM,CAAC;SACzB;QACD,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,QAAQ,CAAC,CAAC;QACtC,UAAU;QACV,IAAM,MAAM,GAAG,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC;QACrC,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE;YACrB,IAAI,CAAC,YAAY,CAAC,MAAM,EAAE,QAAQ,EAAE,WAAW,CAAC,CAAC;SAClD;IACH,CAAC;IAEO,uCAAa,GAArB,UAAsB,KAAa;QACjC,IAAM,SAAS,GAAG,CAAC,kBAAkB,EAAE,iBAAiB,EAAE,YAAY,CAAC,CAAC;QACxE,IAAI,MAAM,GAAG,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QACjC,OAAO,MAAM,EAAE;YACb,IAAM,UAAU,GAAG,MAAM,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;YACtC,IAAI,UAAU,IAAI,eAAQ,CAAC,SAAS,EAAE,UAAU,CAAC,EAAE;gBACjD,OAAO,IAAI,CAAC;aACb;YACD,MAAM,GAAG,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;SAC/B;QACD,OAAO,KAAK,CAAC;IACf,CAAC;IAEO,qCAAW,GAAnB,UAAoB,EAAE;QACpB,IAAM,GAAG,GAAG;YACV,OAAO,EAAE,EAAE,CAAC,OAAO;YACnB,OAAO,EAAE,EAAE,CAAC,OAAO;YACnB,CAAC,EAAE,EAAE,CAAC,CAAC;YACP,CAAC,EAAE,EAAE,CAAC,CAAC;YACP,IAAI,EAAE,IAAI,CAAC,IAAI;YACf,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI;YACnC,MAAM,EAAE,IAAI,CAAC,MAAM;YACnB,MAAM,EAAE,EAAE,CAAC,MAAM;YACjB,MAAM,EAAE,EAAE;SACX,CAAC;QACF,OAAO,GAAG,CAAC;IACb,CAAC;IAEO,sCAAY,GAApB,UAAqB,MAAe,EAAE,QAAkB,EAAE,SAAiB;QAA3E,iBAWC;QAVC,WAAI,CAAC,MAAM,EAAE,UAAC,KAAK;YACjB,IAAM,IAAI,GAAG,KAAK,CAAC,aAAa,EAAE,CAAC;YACnC,IAAI,aAAa,CAAC,EAAE,CAAC,EAAE,QAAQ,CAAC,CAAC,EAAE,CAAC,EAAE,QAAQ,CAAC,CAAC,EAAE,EAAE,IAAI,CAAC,EAAE;gBACzD,KAAK,CAAC,IAAI,CAAC,KAAG,SAAW,EAAE,QAAQ,CAAC,CAAC;gBACrC,IAAM,SAAS,GAAG,KAAK,CAAC,MAAM,CAAC;gBAC/B,IAAI,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE;oBACxB,KAAI,CAAC,YAAY,CAAC,SAAS,EAAE,QAAQ,EAAE,SAAS,CAAC,CAAC;iBACnD;aACF;QACH,CAAC,CAAC,CAAC;IACL,CAAC;IACH,sBAAC;AAAD,CAAC,AAhHD,IAgHC","sourcesContent":["import { wrapBehavior, each, contains } from '@antv/util';\nimport { ICanvas, IShape } from '../../dependents';\nimport BBox from '../../util/bbox';\nimport BasePlot from '../plot';\nimport Layer from '../layer';\nimport { Point } from '../../interface/config';\n\ninterface ControllerConfig {\n  canvas: ICanvas;\n  plot: BasePlot;\n}\n\ninterface IEventHandler {\n  target: ICanvas;\n  type: string;\n  handler: Function;\n}\n\ninterface EventObj {\n  x: number;\n  y: number;\n  clientX: number;\n  clientY: number;\n  target: any;\n  data: any;\n  gEvent: object;\n}\n\nfunction isSameShape(shape1: IShape, shape2: IShape) {\n  if (shape1 && shape2 && shape1 === shape2) {\n    return true;\n  }\n  return false;\n}\n\nfunction isPointInBBox(point: Point, bbox: BBox) {\n  if (point.x >= bbox.minX && point.x <= bbox.maxX && point.y >= bbox.minY && point.y <= bbox.maxY) {\n    return true;\n  }\n  return false;\n}\n\nexport default class EventController {\n  private plot: BasePlot;\n  private canvas: ICanvas;\n  private eventHandlers: IEventHandler[];\n  private lastShape: any;\n\n  constructor(cfg: ControllerConfig) {\n    this.plot = cfg.plot;\n    this.canvas = cfg.canvas;\n    this.eventHandlers = [];\n  }\n\n  public bindEvents() {\n    this.addEvent(this.canvas, 'mousedown', wrapBehavior(this, 'onEvents'));\n    this.addEvent(this.canvas, 'mousemove', wrapBehavior(this, 'onMove'));\n    this.addEvent(this.canvas, 'mouseup', wrapBehavior(this, 'onEvents'));\n    this.addEvent(this.canvas, 'click', wrapBehavior(this, 'onEvents'));\n    this.addEvent(this.canvas, 'dblclick', wrapBehavior(this, 'onEvents'));\n    this.addEvent(this.canvas, 'contextmenu', wrapBehavior(this, 'onEvents'));\n    this.addEvent(this.canvas, 'wheel', wrapBehavior(this, 'onEvents'));\n  }\n\n  public clearEvents() {\n    const eventHandlers = this.eventHandlers;\n    each(eventHandlers, (eh) => {\n      eh.target.off(eh.type, eh.handler);\n    });\n  }\n\n  private addEvent(target: ICanvas, eventType: string, handler: Function) {\n    target.on(eventType, handler);\n    this.eventHandlers.push({ target, type: eventType, handler });\n  }\n\n  private onEvents(ev) {\n    const eventObj = this.getEventObj(ev);\n    const target: any = ev.target;\n    // 判断是否拾取到view以外的shape\n    if (!this.isShapeInView(target) && target.name) {\n      this.plot.emit(`${target.name}:${ev.type}`, ev);\n    }\n    this.plot.emit(`${ev.type}`, eventObj);\n    // layer事件\n    const layers = this.plot.getLayers();\n    if (layers.length > 0) {\n      this.onLayerEvent(layers, eventObj, ev.type);\n    }\n  }\n\n  private onMove(ev) {\n    const target: any = ev.target;\n    const eventObj = this.getEventObj(ev);\n    // shape的mouseenter, mouseleave和mousemove事件\n    if (!this.isShapeInView(target) && target.name) {\n      this.plot.emit(`${target.name}:${ev.type}`, eventObj);\n      // mouseleave & mouseenter\n      if (this.lastShape && !isSameShape(target, this.lastShape)) {\n        if (this.lastShape) {\n          this.plot.emit(`${this.lastShape.name}:mouseleave`, eventObj);\n        }\n        this.plot.emit(`${target.name}:mouseenter`, eventObj);\n      }\n      this.lastShape = target;\n    }\n    this.plot.emit('mousemove', eventObj);\n    // layer事件\n    const layers = this.plot.getLayers();\n    if (layers.length > 0) {\n      this.onLayerEvent(layers, eventObj, 'mousemove');\n    }\n  }\n\n  private isShapeInView(shape: IShape) {\n    const groupName = ['frontgroundGroup', 'backgroundGroup', 'panelGroup'];\n    let parent = shape.get('parent');\n    while (parent) {\n      const parentName = parent.get('name');\n      if (parentName && contains(groupName, parentName)) {\n        return true;\n      }\n      parent = parent.get('parent');\n    }\n    return false;\n  }\n\n  private getEventObj(ev) {\n    const obj = {\n      clientX: ev.clientX,\n      clientY: ev.clientY,\n      x: ev.x,\n      y: ev.y,\n      plot: this.plot,\n      data: ev.data ? ev.data.data : null,\n      canvas: this.canvas,\n      target: ev.target,\n      gEvent: ev, // g事件的event\n    };\n    return obj;\n  }\n\n  private onLayerEvent(layers: Layer[], eventObj: EventObj, eventName: string) {\n    each(layers, (layer) => {\n      const bbox = layer.getGlobalBBox();\n      if (isPointInBBox({ x: eventObj.x, y: eventObj.y }, bbox)) {\n        layer.emit(`${eventName}`, eventObj);\n        const subLayers = layer.layers;\n        if (subLayers.length > 0) {\n          this.onLayerEvent(subLayers, eventObj, eventName);\n        }\n      }\n    });\n  }\n}\n"]}