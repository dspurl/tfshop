{"version":3,"file":"layer.js","sourceRoot":"","sources":["../../../src/plots/scatter/layer.ts"],"names":[],"mappings":"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","sourcesContent":["import { deepMix, isNil, get, has, find } from '@antv/util';\nimport { registerPlotType } from '../../base/global';\nimport { LayerConfig } from '../../base/layer';\nimport ViewLayer, { ViewConfig } from '../../base/view-layer';\nimport { getGeom } from '../../geoms/factory';\nimport { ITimeAxis, IValueAxis, DataItem, GraphicStyle } from '../../interface/config';\nimport { extractScale } from '../../util/scale';\nimport Quadrant, { QuadrantConfig } from './components/quadrant';\nimport Trendline, { TrendlineConfig } from './components/trendline';\nimport * as EventParser from './event';\nimport { getComponent } from '../../components/factory';\nimport './theme';\n\nconst G2_GEOM_MAP = {\n  scatter: 'point',\n};\n\nconst PLOT_GEOM_MAP = {\n  point: 'point',\n};\n\nexport interface PointViewConfig extends ViewConfig {\n  /** 散点样式 */\n  pointStyle?: GraphicStyle | ((...args: any) => GraphicStyle);\n  /** 颜色字段 */\n  colorField?: string | string[];\n  /** x 轴配置 */\n  xAxis?: ITimeAxis | IValueAxis;\n  /** y 轴配置 */\n  yAxis?: ITimeAxis | IValueAxis;\n  quadrant?: QuadrantConfig;\n  trendline?: TrendlineConfig;\n}\n\nexport interface ScatterViewConfig extends PointViewConfig {\n  /** 散点大小 */\n  pointSize?: number | any;\n}\n\nexport interface ScatterLayerConfig extends ScatterViewConfig, LayerConfig {}\n\nexport default class ScatterLayer<T extends ScatterLayerConfig = ScatterLayerConfig> extends ViewLayer<T> {\n  public static getDefaultOptions(): any {\n    return deepMix({}, super.getDefaultOptions(), {\n      pointSize: 4,\n      pointStyle: {\n        lineWidth: 1,\n        strokeOpacity: 1,\n        fillOpacity: 0.95,\n        stroke: '#fff',\n      },\n      xAxis: {\n        nice: true,\n        grid: {\n          visible: true,\n        },\n        line: {\n          visible: true,\n        },\n      },\n      yAxis: {\n        nice: true,\n        grid: {\n          visible: true,\n        },\n        line: {\n          visible: true,\n        },\n      },\n      tooltip: {\n        visible: true,\n        // false 会造成 tooltip 只能显示一条数据，true 会造成 tooltip 在空白区域也会显示\n        shared: null,\n        showTitle: false,\n        showMarkers: false,\n        showCrosshairs: false,\n      },\n      label: {\n        visible: false,\n      },\n      shape: 'circle',\n    });\n  }\n\n  public type: string = 'scatter';\n  public points: any;\n  protected quadrant: Quadrant;\n  protected trendline: Trendline;\n\n  public afterRender() {\n    super.afterRender();\n    if (this.quadrant) {\n      this.quadrant.destroy();\n    }\n    if (this.trendline) {\n      this.trendline.destroy();\n    }\n    if (this.options.quadrant && this.options.quadrant.visible) {\n      this.quadrant = new Quadrant({\n        view: this.view,\n        plotOptions: this.options,\n        ...this.options.quadrant,\n      });\n      this.quadrant.render();\n    }\n    if (this.options.trendline && this.options.trendline.visible) {\n      this.trendline = new Trendline({\n        view: this.view,\n        plotOptions: this.options,\n        ...this.options.trendline,\n      });\n      this.trendline.render();\n    }\n  }\n\n  public destroy() {\n    if (this.quadrant) {\n      this.quadrant.destroy();\n      this.quadrant = null;\n    }\n    if (this.trendline) {\n      this.trendline.destroy();\n      this.trendline = null;\n    }\n    super.destroy();\n  }\n\n  private isValidLinearValue(value) {\n    if (isNil(value)) {\n      return false;\n    } else if (Number.isNaN(Number(value))) {\n      return false;\n    }\n    return true;\n  }\n\n  protected processData(data?: DataItem[]): DataItem[] | undefined {\n    const { xField, yField } = this.options;\n    const xAxisType = get(this.options, ['xAxis', 'type'], 'linear');\n    const yAxisType = get(this.options, ['yAxis', 'type'], 'linear');\n    if (xAxisType && yAxisType) {\n      const fiteredData = data\n        .filter((item) => {\n          if (xAxisType === 'linear' && !this.isValidLinearValue(item[xField])) {\n            return false;\n          }\n          if (yAxisType === 'linear' && !this.isValidLinearValue(item[yField])) {\n            return false;\n          }\n          return true;\n        })\n        .map((item) => {\n          return {\n            ...item,\n            [xField]: xAxisType === 'linear' ? Number(item[xField]) : String(item[xField]),\n            [yField]: yAxisType === 'linear' ? Number(item[yField]) : String(item[yField]),\n          };\n        });\n      return fiteredData;\n    }\n\n    return data;\n  }\n\n  protected geometryParser(dim, type) {\n    if (dim === 'g2') {\n      return G2_GEOM_MAP[type];\n    }\n    return PLOT_GEOM_MAP[type];\n  }\n\n  protected scale() {\n    const props = this.options;\n    const scales = {};\n    /** 配置x-scale */\n    scales[props.xField] = {};\n    if (has(props, 'xAxis')) {\n      extractScale(scales[props.xField], props.xAxis);\n    }\n    /** 配置y-scale */\n    scales[props.yField] = {};\n    if (has(props, 'yAxis')) {\n      extractScale(scales[props.yField], props.yAxis);\n    }\n    const timeLineInteraction = find(props.interactions, (interaction) => {\n      return interaction.type === 'timeline';\n    });\n    if (timeLineInteraction && get(timeLineInteraction, 'cfg.key')) {\n      const keyField = timeLineInteraction.cfg.key;\n      if (scales[keyField]) {\n        scales[keyField].key = true;\n      } else {\n        scales[keyField] = { key: true };\n      }\n    }\n    this.setConfig('scales', scales);\n    super.scale();\n  }\n\n  protected coord() {\n    return;\n  }\n\n  protected annotation() {\n    return;\n  }\n\n  protected addGeometry() {\n    const points = getGeom('point', 'circle', {\n      plot: this,\n    });\n    this.points = points;\n    if (this.options.tooltip && this.options.tooltip.visible) {\n      const { showTitle, titleField } = this.options.tooltip;\n      this.extractTooltip();\n      this.setConfig('tooltip', {\n        showTitle,\n        title: showTitle ? titleField : undefined,\n        ...this.options.tooltip,\n      } as any);\n    }\n    if (this.options.label) {\n      this.label();\n    }\n    this.setConfig('geometry', points);\n  }\n\n  protected label() {\n    const props = this.options;\n\n    if (props.label.visible === false) {\n      if (this.points) {\n        this.points.label = false;\n      }\n      return;\n    }\n\n    const label = getComponent('label', {\n      fields: props.label.field ? [props.label.field] : [props.yField],\n      ...props.label,\n      plot: this,\n    });\n\n    if (this.points) {\n      this.points.label = label;\n    }\n  }\n\n  protected animation() {\n    super.animation();\n    const props = this.options;\n    if (props.animation === false) {\n      /** 关闭动画 */\n      this.points.animate = false;\n    }\n  }\n\n  protected parseEvents(eventParser) {\n    // 气泡图继承散点图时，会存在 eventParser\n    super.parseEvents(eventParser || EventParser);\n  }\n\n  protected extractTooltip() {\n    this.points.tooltip = {};\n    const tooltipOptions: any = this.options.tooltip;\n    if (tooltipOptions.fields) {\n      this.points.tooltip.fields = tooltipOptions.fields;\n    } else {\n      this.points.tooltip.fields = [this.options.xField, this.options.yField];\n    }\n    if (tooltipOptions.formatter) {\n      this.points.tooltip.callback = tooltipOptions.formatter;\n      if (this.options.colorField) {\n        this.points.tooltip.fields.push(this.options.colorField);\n      }\n    }\n  }\n}\n\nregisterPlotType('scatter', ScatterLayer);\n"]}