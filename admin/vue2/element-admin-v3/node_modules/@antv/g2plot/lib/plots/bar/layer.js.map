{"version":3,"file":"layer.js","sourceRoot":"","sources":["../../../src/plots/bar/layer.ts"],"names":[],"mappings":"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","sourcesContent":["import { deepMix, has, each, clone } from '@antv/util';\nimport { registerPlotType } from '../../base/global';\nimport { LayerConfig } from '../../base/layer';\nimport ViewLayer from '../../base/view-layer';\nimport { getComponent } from '../../components/factory';\nimport ConversionTag from '../../components/conversion-tag';\nimport { getGeom } from '../../geoms/factory';\nimport { ElementOption, DataItem } from '../../interface/config';\nimport { extractScale } from '../../util/scale';\nimport responsiveMethods from './apply-responsive';\nimport './theme';\nimport './component/label';\nimport './component/label-auto';\nimport * as EventParser from './event';\nimport { getGeometryByType } from '../../util/view';\nimport { BarViewConfig } from './interface';\nimport { Maybe } from '../../interface/types';\n\nconst G2_GEOM_MAP = {\n  bar: 'interval',\n};\n\nconst PLOT_GEOM_MAP = {\n  interval: 'bar',\n};\n\nexport interface BarLayerConfig extends BarViewConfig, LayerConfig {}\n\nexport default class BaseBarLayer<T extends BarLayerConfig = BarLayerConfig> extends ViewLayer<T> {\n  public static getDefaultOptions(): Partial<BarViewConfig> {\n    const cfg: Partial<BarViewConfig> = {\n      xAxis: {\n        visible: true,\n        line: {\n          visible: false,\n        },\n        title: {\n          visible: true,\n        },\n        label: {\n          visible: false,\n        },\n        tickLine: {\n          visible: false,\n        },\n        grid: {\n          visible: false,\n        },\n        nice: true,\n      },\n      yAxis: {\n        visible: true,\n        grid: {\n          visible: false,\n        },\n        line: {\n          visible: false,\n        },\n        tickLine: {\n          visible: false,\n        },\n        label: {\n          visible: true,\n          autoRotate: false,\n          autoHide: true,\n        },\n        title: {\n          visible: false,\n          spacing: 12,\n        },\n      },\n      tooltip: {\n        visible: true,\n        shared: true,\n        showCrosshairs: false,\n        showMarkers: false,\n      },\n      label: {\n        visible: true,\n        position: 'left',\n        adjustColor: true,\n      },\n      legend: {\n        visible: false,\n        position: 'top-left',\n      },\n      interactions: [\n        { type: 'tooltip' },\n        { type: 'active-region' },\n        { type: 'legend-active' },\n        { type: 'legend-filter' },\n      ],\n      conversionTag: {\n        visible: false,\n      },\n    };\n    return deepMix({}, super.getDefaultOptions(), cfg);\n  }\n\n  public bar: any;\n  public type: string = 'bar';\n  public conversionTag?: ConversionTag;\n\n  public beforeInit() {\n    super.beforeInit();\n    const props = this.options;\n    /** 响应式图形 */\n    if (props.responsive && props.padding !== 'auto') {\n      this.applyResponsive('preRender');\n    }\n  }\n\n  public afterRender() {\n    const props = this.options;\n    this.renderLabel();\n    /** 响应式 */\n    if (props.responsive && props.padding !== 'auto') {\n      this.applyResponsive('afterRender');\n    }\n    if (props.conversionTag.visible) {\n      this.conversionTag = new ConversionTag({\n        view: this.view,\n        field: props.xField,\n        animation: props.animation === false ? false : true,\n        ...props.conversionTag,\n      });\n    }\n    super.afterRender();\n  }\n\n  protected geometryParser(dim, type) {\n    if (dim === 'g2') {\n      return G2_GEOM_MAP[type];\n    }\n    return PLOT_GEOM_MAP[type];\n  }\n\n  protected processData(originData?: DataItem[]) {\n    const inputData = originData ? originData.slice().reverse() : originData;\n    const { yField } = this.options;\n    const processedData = [];\n    each(inputData, (data) => {\n      const d = clone(data);\n      d[yField] = d[yField].toString();\n      processedData.push(d);\n    });\n    return processedData;\n  }\n\n  protected scale() {\n    const props = this.options;\n    const scales = {};\n    /** 配置x-scale */\n    scales[props.yField] = {\n      type: 'cat',\n    };\n    if (has(props, 'yAxis')) {\n      extractScale(scales[props.yField], props.yAxis);\n    }\n    /** 配置y-scale */\n    scales[props.xField] = {};\n    if (has(props, 'xAxis')) {\n      extractScale(scales[props.xField], props.xAxis);\n    }\n    this.setConfig('scales', scales);\n    super.scale();\n  }\n\n  protected coord() {\n    this.setConfig('coordinate', {\n      actions: [['transpose']],\n    });\n  }\n\n  protected axis(): void {\n    const xAxis_parser = getComponent('axis', {\n      plot: this,\n      dim: 'x',\n    });\n    const yAxis_parser = getComponent('axis', {\n      plot: this,\n      dim: 'y',\n    });\n    /** 转置坐标系特殊配置 */\n    if (xAxis_parser) {\n      xAxis_parser.position = 'left';\n    }\n    if (yAxis_parser) {\n      yAxis_parser.position = 'bottom';\n    }\n    const axesConfig = {};\n    axesConfig[this.options.xField] = xAxis_parser;\n    axesConfig[this.options.yField] = yAxis_parser;\n    /** 存储坐标轴配置项到config */\n    this.setConfig('axes', axesConfig);\n  }\n\n  //eslint-disable-next-line @typescript-eslint/no-unused-vars\n  protected adjustBar(bar: ElementOption) {\n    return null;\n  }\n\n  protected addGeometry() {\n    const props: any = this.options;\n    const bar = getGeom('interval', 'main', {\n      positionFields: [props.yField, props.xField],\n      plot: this,\n    });\n    if (props.conversionTag.visible) {\n      this.setConfig(\n        'theme',\n        deepMix({}, this.getTheme(), {\n          columnWidthRatio: 1 / 3,\n        })\n      );\n    }\n    this.adjustBar(bar);\n    this.bar = bar;\n\n    if (props.tooltip && (props.tooltip.fields || props.tooltip.formatter)) {\n      this.geometryTooltip();\n    }\n\n    this.setConfig('geometry', bar);\n  }\n\n  protected animation() {\n    super.animation();\n    const props = this.options;\n    if (props.animation === false) {\n      /** 关闭动画 */\n      this.bar.animate = false;\n    }\n  }\n\n  protected parseEvents() {\n    super.parseEvents(EventParser);\n  }\n\n  protected renderLabel() {\n    const { scales } = this.config;\n    const { label, xField } = this.options;\n    const scale = scales[xField];\n    if (label?.visible) {\n      const geometry = getGeometryByType(this.view, 'interval');\n      this.doRenderLabel(geometry, {\n        type: 'bar',\n        formatter: scale.formatter && ((value: Maybe<string | number>) => scale.formatter(value)),\n        ...this.options.label,\n      });\n    }\n  }\n\n  protected geometryTooltip() {\n    this.bar.tooltip = {};\n    const tooltipOptions: any = this.options.tooltip;\n    if (tooltipOptions.fields) {\n      this.bar.tooltip.fields = tooltipOptions.fields;\n    }\n    if (tooltipOptions.formatter) {\n      this.bar.tooltip.callback = tooltipOptions.formatter;\n      if (!tooltipOptions.fields) {\n        this.bar.tooltip.fields = [this.options.xField, this.options.yField];\n        if (this.options.colorField) {\n          this.bar.tooltip.fields.push(this.options.colorField);\n        }\n      }\n    }\n  }\n\n  private applyResponsive(stage) {\n    const methods = responsiveMethods[stage];\n    each(methods, (r) => {\n      const responsive = r;\n      responsive.method(this);\n    });\n  }\n\n  public getLabelOptionsByPosition(position: string) {\n    if (position === 'middle') {\n      return {\n        offset: 0,\n      };\n    }\n\n    if (position === 'left') {\n      return {\n        offset: 7,\n        style: {\n          stroke: null,\n          lineWidth: 0,\n        },\n      };\n    }\n\n    if (position === 'right') {\n      return {\n        offset: 4,\n      };\n    }\n  }\n}\n\nregisterPlotType('bar', BaseBarLayer);\n"]}