{"version":3,"file":"data.js","sourceRoot":"","sources":["../../src/util/data.ts"],"names":[],"mappings":";;;;AAAA,mCAAsF;AAGzE,QAAA,uBAAuB,GAAG,UAAC,IAAgB,EAAE,UAAkB,EAAE,QAAkB;IAC9F,0BAA0B;IAC1B,IAAI,KAAK,GAAG,cAAO,CAAC,IAAI,EAAE,UAAU,CAAC,CAAC;IACtC,KAAK,GAAG,gBAAS,CAAC,KAAK,EAAE,UAAC,KAAK,IAAK,OAAA,UAAG,CAAC,KAAK,EAAE,UAAC,IAAI,IAAK,OAAA,UAAG,CAAC,QAAQ,EAAE,UAAC,KAAK,IAAK,OAAA,IAAI,CAAC,KAAK,CAAC,EAAX,CAAW,CAAC,EAArC,CAAqC,CAAC,EAA3D,CAA2D,CAAC,CAAC;IACjG,KAAK,GAAG,gBAAS,CAAC,KAAK,EAAE,cAAO,CAAC,CAAC;IAClC,KAAK,GAAG,gBAAS,CAAC,KAAK,EAAE,UAAC,IAAI;QAC5B,OAAA,UAAG,CAAC,IAAI,EAAE,UAAC,GAAG;YACZ,aAAa;YACb,IAAM,CAAC,GAAG,MAAM,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;YACjC,IAAI,CAAC,eAAQ,CAAC,CAAC,CAAC,IAAI,KAAK,CAAC,CAAC,CAAC,EAAE;gBAC5B,OAAO,CAAC,CAAC;aACV;YACD,OAAO,CAAC,CAAC;QACX,CAAC,CAAC;IAPF,CAOE,CACH,CAAC;IACF,aAAa;IACb,IAAM,WAAW,GAAG,gBAAS,CAAC,KAAK,EAAE,UAAC,IAAc,IAAK,OAAA,aAAM,CAAC,IAAI,EAAE,UAAC,GAAG,EAAE,GAAG,IAAK,OAAA,GAAG,GAAG,GAAG,EAAT,CAAS,EAAE,CAAC,CAAC,EAAxC,CAAwC,CAAC,CAAC;IAEnG,wBAAwB;IACxB,IAAM,OAAO,GAAG,UAAG,CAAC,IAAI,EAAE,UAAC,IAAI;QAC7B,aAAa;QACb,IAAM,GAAG,yCAAQ,IAAI,KAAE,OAAO,EAAE,IAAI,EAAE,KAAK,EAAE,WAAW,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,GAAE,CAAC;QAC7E,WAAI,CAAC,QAAQ,EAAE,UAAC,KAAK;YACnB,aAAa;YACb,GAAG,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,WAAW,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC;QAClE,CAAC,CAAC,CAAC;QAEH,OAAO,GAAG,CAAC;IACb,CAAC,CAAC,CAAC;IAEH,cAAc;IACd,WAAI,CAAC,cAAO,CAAC,OAAO,EAAE,UAAU,CAAC,EAAE,UAAC,KAAiB;QACnD,IAAI,GAAG,GAAG,CAAC,CAAC;QACZ,WAAI,CAAC,KAAK,EAAE,UAAC,IAAc,EAAE,OAAe;YAC1C,WAAI,CAAC,QAAQ,EAAE,UAAC,KAAa,EAAE,QAAgB;gBAC7C,aAAa;gBACb,IAAI,GAAG,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,KAAK,KAAK,CAAC,MAAM,GAAG,CAAC,IAAI,QAAQ,KAAK,QAAQ,CAAC,MAAM,GAAG,CAAC,IAAI,GAAG,GAAG,CAAC,CAAC,EAAE;oBAC3G,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAAG,GAAG,CAAC;iBACvB;gBACD,aAAa;gBACb,GAAG,IAAI,IAAI,CAAC,KAAK,CAAC,CAAC;YACrB,CAAC,CAAC,CAAC;QACL,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IACH,aAAa;IACb,OAAO,OAAO,CAAC;AACjB,CAAC,CAAC","sourcesContent":["import { groupBy, mapValues, map, flatten, isNumber, reduce, each } from '@antv/util';\nimport { DataItem } from '../interface/config';\n\nexport const transformDataPercentage = (data: DataItem[], groupField: string, measures: string[]): DataItem[] => {\n  // 按照groupBy字段计算各个group的总和\n  let chain = groupBy(data, groupField);\n  chain = mapValues(chain, (items) => map(items, (item) => map(measures, (field) => item[field])));\n  chain = mapValues(chain, flatten);\n  chain = mapValues(chain, (vals) =>\n    map(vals, (val) => {\n      // @ts-ignore\n      const v = Number.parseFloat(val);\n      if (!isNumber(v) || isNaN(v)) {\n        return 0;\n      }\n      return v;\n    })\n  );\n  // @ts-ignore\n  const groupTotals = mapValues(chain, (vals: number[]) => reduce(vals, (sum, val) => sum + val, 0));\n\n  // 覆盖measures字段的值为对于的百分比\n  const newData = map(data, (item) => {\n    // @ts-ignore\n    const rst = { ...item, _origin: item, total: groupTotals[item[groupField]] };\n    each(measures, (field) => {\n      // @ts-ignore\n      rst[field] = item[field] / (groupTotals[item[groupField]] || 1);\n    });\n\n    return rst;\n  });\n\n  // 检查精度，确保总和为1\n  each(groupBy(newData, groupField), (items: DataItem[]) => {\n    let sum = 0;\n    each(items, (item: DataItem, itemIdx: number) => {\n      each(measures, (field: string, fieldIdx: number) => {\n        // @ts-ignore\n        if (sum + item[field] >= 1 || (itemIdx === items.length - 1 && fieldIdx === measures.length - 1 && sum > 0)) {\n          item[field] = 1 - sum;\n        }\n        // @ts-ignore\n        sum += item[field];\n      });\n    });\n  });\n  // @ts-ignore\n  return newData;\n};\n"]}