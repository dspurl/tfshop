{"version":3,"file":"label.js","sourceRoot":"","sources":["../../../../src/plots/heatmap/component/label.ts"],"names":[],"mappings":"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","sourcesContent":["import { each, deepMix, clone } from '@antv/util';\nimport { View, IGroup } from '../../../dependents';\nimport { rgb2arr, mappingColor } from '../../../util/color';\n\nexport interface MatrixLabelConfig {\n  visible: boolean;\n  formatter?: (...args: any[]) => string;\n  offsetX?: number;\n  offsetY?: number;\n  style?: any;\n  adjustColor?: boolean;\n  adjustPosition?: boolean;\n}\n\nexport interface IMatrixLabel extends MatrixLabelConfig {\n  view: View;\n  plot: any;\n}\n\nexport default class MatrixLabel {\n  public options: MatrixLabelConfig;\n  public destroyed: boolean = false;\n  protected plot: any;\n  protected view: View;\n  private container: IGroup;\n\n  constructor(cfg: IMatrixLabel) {\n    this.view = cfg.view;\n    this.plot = cfg.plot;\n    const defaultOptions = this.getDefaultOptions();\n    this.options = deepMix(defaultOptions, cfg, {});\n    this.init();\n  }\n\n  protected init() {\n    this.container = this.view.geometries[0].labelsContainer;\n    this.view.on('beforerender', () => {\n      this.clear();\n      this.plot.canvas.draw();\n    });\n  }\n\n  public render() {\n    const elements = this.view.geometries[0].elements;\n    each(elements, (ele) => {\n      const { shape } = ele;\n      const { style, offsetX, offsetY } = this.options;\n      const formatter = this.options.formatter;\n      const content = formatter ? formatter(this.getContent(shape)) : this.getContent(shape);\n      const position = this.getPosition(shape);\n      const color = this.getTextColor(shape);\n      const label = this.container.addShape('text', {\n        attrs: deepMix({}, style, {\n          x: position.x + offsetX,\n          y: position.y + offsetY,\n          text: content,\n          fill: color,\n          textAlign: 'center',\n          textBaseline: 'middle',\n        }),\n        name: 'label',\n      });\n      if (this.options.adjustPosition) {\n        this.adjustLabel(label, shape);\n      }\n    });\n  }\n\n  public clear() {\n    if (this.container) {\n      this.container.clear();\n    }\n  }\n\n  public hide() {\n    this.container.set('visible', false);\n    this.plot.canvas.draw();\n  }\n\n  public show() {\n    this.container.set('visible', true);\n    this.plot.canvas.draw();\n  }\n\n  public destroy() {\n    if (this.container) {\n      this.container.remove();\n    }\n    this.destroyed = true;\n  }\n\n  public getBBox() {\n    return this.container.getBBox();\n  }\n\n  private getDefaultOptions() {\n    const { theme } = this.plot;\n    const labelStyle = theme.label.style;\n    return {\n      offsetX: 0,\n      offsetY: 0,\n      style: clone(labelStyle),\n    };\n  }\n\n  protected getContent(shape) {\n    const data = shape.get('origin').data;\n    const field = this.plot.options.colorField;\n    return data[field];\n  }\n\n  protected getPosition(shape) {\n    const bbox = shape.getBBox();\n    return {\n      x: bbox.minX + bbox.width / 2,\n      y: bbox.minY + bbox.height / 2,\n    };\n  }\n\n  protected getTextColor(shape) {\n    if (this.options.adjustColor) {\n      const shapeColor = shape.attr('fill');\n      const shapeOpacity = shape.attr('opacity') ? shape.attr('opacity') : 1;\n      const rgb = rgb2arr(shapeColor);\n      const gray = Math.round(rgb[0] * 0.299 + rgb[1] * 0.587 + rgb[2] * 0.114) / shapeOpacity;\n      const colorBand = [\n        { from: 0, to: 85, color: 'white' },\n        { from: 85, to: 170, color: '#F6F6F6' },\n        { from: 170, to: 255, color: 'black' },\n      ];\n      const reflect = mappingColor(colorBand, gray);\n      return reflect;\n    }\n    const defaultColor = this.options.style.fill;\n    return defaultColor;\n  }\n\n  protected adjustLabel(label, shape) {\n    const labelRange = label.getBBox();\n    const shapeRange = shape.getBBox();\n    if (labelRange.width > shapeRange.width || labelRange.height > shapeRange.height) {\n      label.attr('text', '');\n    }\n  }\n}\n"]}