{"version":3,"file":"clipIn-with-data.js","sourceRoot":"","sources":["../../../../src/plots/line/animation/clipIn-with-data.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,iBAAiB,EAAE,MAAM,qBAAqB,CAAC;AACxD,OAAO,EAAE,KAAK,EAAE,UAAU,EAAE,KAAK,EAAE,OAAO,EAAE,MAAM,YAAY,CAAC;AAE/D,IAAI,QAAQ,CAAC;AAEb,SAAS,eAAe,CAAC,KAAK,EAAE,UAAU;IACxC,IAAM,UAAU,GAAG;QACjB,MAAM,EAAE,YAAY;QACpB,QAAQ,EAAE,KAAK;KAChB,CAAC;IACF,IAAM,eAAe,GAAG,OAAO,CAAC,EAAE,EAAE,UAAU,EAAE,UAAU,CAAC,CAAC;IAC5D,IAAM,QAAQ,GAAG,KAAK,CAAC,GAAG,CAAC,SAAS,CAAC,CAAC,QAAQ,CAAC;IAC/C,QAAQ,CAAC,eAAe,CAAC,GAAG,CAAC,SAAS,EAAE,KAAK,CAAC,CAAC;IAC/C,aAAa;IACb,IAAM,KAAK,GAAG,KAAK,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;IACjC,IAAM,KAAK,GAAG,QAAQ,CAAC,UAAU,CAAC;IAClC,IAAM,MAAM,GAAG,QAAQ,CAAC,MAAM,CAAC;IAC/B,IAAM,MAAM,GAAG,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;IAC/C,IAAM,SAAS,GAAG,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC,CAAC;IAC7C,OAAO,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;IACtB,IAAM,IAAI,GAAG,KAAK,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;IACpC,IAAM,MAAM,GAAG,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;IACnC,IAAM,OAAO,GAAG,EAAE,CAAC;IACnB,IAAI,KAAK,GAAG,IAAI,CAAC;IACT,IAAA,WAAW,GAAK,QAAQ,CAAC,OAAO,YAArB,CAAsB;IACzC,IAAI,WAAW,EAAE;QACf,KAAK,GAAG,MAAM,CAAC,QAAQ,CAAC,MAAM,EAAE;YAC9B,KAAK,EAAE;gBACL,CAAC,EAAE,KAAK,CAAC,KAAK,CAAC,CAAC,GAAG,OAAO;gBAC1B,CAAC,EAAE,CAAC;gBACJ,IAAI,EAAE,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC;gBACpC,IAAI,EAAE,KAAK,CAAC,IAAI,CAAC,QAAQ,CAAC;gBAC1B,QAAQ,EAAE,EAAE;gBACZ,SAAS,EAAE,OAAO;gBAClB,YAAY,EAAE,QAAQ;aACvB;SACF,CAAC,CAAC;KACJ;IACD,IAAM,OAAO,GAAG,KAAK,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,CAAC;IAC/B,IAAM,MAAM,GAAG,MAAM,CAAC,QAAQ,CAAC,MAAM,EAAE;QACrC,KAAK,EAAE;YACL,CAAC,EAAE,KAAK,CAAC,KAAK,CAAC,CAAC,GAAG,OAAO;YAC1B,CAAC,EAAE,OAAO;YACV,IAAI,EAAE,SAAO,KAAO;YACpB,IAAI,EAAE,KAAK,CAAC,IAAI,CAAC,QAAQ,CAAC;YAC1B,QAAQ,EAAE,EAAE;YACZ,SAAS,EAAE,OAAO;YAClB,YAAY,EAAE,QAAQ;SACvB;KACF,CAAC,CAAC;IACH,aAAa;IACb,eAAe,CAAC,QAAQ,GAAG;QACzB,IAAI,KAAK,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,WAAW,CAAC,EAAE;YACpC,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;YACpB,IAAI,CAAC,MAAM,EAAE,CAAC;YACd,MAAM,CAAC,OAAO,CACZ;gBACE,OAAO,EAAE,CAAC;aACX,EACD,GAAG,EACH;gBACE,MAAM,CAAC,MAAM,EAAE,CAAC;gBAChB,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,EAAE;oBACjB,KAAK,CAAC,MAAM,EAAE,CAAC;iBAChB;gBACD,IAAM,eAAe,GAAG,QAAQ,CAAC,eAAe,CAAC;gBACjD,IAAI,CAAC,eAAe,CAAC,GAAG,CAAC,SAAS,CAAC,EAAE;oBACnC,eAAe,CAAC,GAAG,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;iBACtC;YACH,CAAC,CACF,CAAC;SACH;IACH,CAAC,CAAC;IACF,WAAW;IACX,aAAa;IACb,IAAI,KAAK,GAAG,eAAe,CAAC,KAAK,CAAC;IAClC,IAAI,UAAU,CAAC,KAAK,CAAC,EAAE;QACrB,KAAK,GAAG,eAAe,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;KACtC;IACD,IAAI,MAAM,GAAG,eAAe,CAAC,MAAM,CAAC;IACpC,IAAI,UAAU,CAAC,MAAM,CAAC,EAAE;QACtB,MAAM,GAAG,eAAe,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;KACxC;IACD,UAAU;IACV,IAAI,CAAC,OAAO,CACV;QACE,KAAK,EAAE,KAAK,CAAC,QAAQ,EAAE;KACxB,EACD,eAAe,CAAC,QAAQ,EACxB,MAAM,EACN,eAAe,CAAC,QAAQ,EACxB,KAAK,CACN,CAAC;IACF,CAAC,eAAe,CAAC,OAAO,GAAG,UAAC,KAAK;QAC/B,IAAM,QAAQ,GAAG,kBAAkB,CAAC,KAAK,EAAE,SAAS,EAAE,KAAK,CAAC,CAAC;QAC7D,IAAI,CAAC,QAAQ;YAAE,OAAO;QAEtB,MAAM,CAAC,IAAI,CAAC,GAAG,EAAE,QAAQ,CAAC,CAAC,CAAC,GAAG,OAAO,CAAC,CAAC;QACxC,MAAM,CAAC,IAAI,CAAC,GAAG,EAAE,QAAQ,CAAC,CAAC,CAAC,GAAG,OAAO,CAAC,CAAC;QACxC,IAAI,KAAK,GAAG,iBAAiB,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC;QAE1D,gBAAgB;QAChB,IAAI,MAAM,CAAC,SAAS,EAAE;YACpB,KAAK,GAAG,MAAM,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;SACjC;QAED,MAAM,CAAC,IAAI,CAAC,MAAM,EAAE,KAAK,CAAC,CAAC;IAC7B,CAAC,CAAC;QACA,MAAM,CAAC,OAAO,CAAC,eAAe,CAAC,OAAO,EAAE;YACtC,QAAQ,EAAE,eAAe,CAAC,QAAQ;YAClC,MAAM,QAAA;YACN,QAAQ,EAAE,eAAe,CAAC,QAAQ;YAClC,KAAK,OAAA;SACN,CAAC,CAAC;IACL,IAAI,KAAK,EAAE;QACT,KAAK,CAAC,OAAO,CACX;YACE,OAAO,EAAE,UAAC,KAAK;gBACb,IAAM,QAAQ,GAAG,kBAAkB,CAAC,KAAK,EAAE,SAAS,EAAE,KAAK,CAAC,CAAC;gBAC7D,IAAI,CAAC,QAAQ;oBAAE,OAAO;gBACtB,KAAK,CAAC,IAAI,CAAC,GAAG,EAAE,QAAQ,CAAC,CAAC,CAAC,GAAG,OAAO,CAAC,CAAC;gBACvC,KAAK,CAAC,IAAI,CAAC,GAAG,EAAE,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC;YAC/B,CAAC;SACF,EACD,eAAe,CAAC,QAAQ,EACxB,MAAM,EACN,eAAe,CAAC,QAAQ,EACxB,KAAK,CACN,CAAC;KACH;AACH,CAAC;AAED,SAAS,OAAO,CAAC,KAAK,EAAE,KAAK;IACnB,IAAA,KAAK,GAAkB,KAAK,MAAvB,EAAE,GAAG,GAAa,KAAK,IAAlB,EAAE,MAAM,GAAK,KAAK,OAAV,CAAW;IACrC,KAAK,CAAC,OAAO,CAAC;QACZ,IAAI,EAAE,MAAM;QACZ,KAAK,EAAE;YACL,CAAC,EAAE,KAAK,CAAC,CAAC;YACV,CAAC,EAAE,GAAG,CAAC,CAAC;YACR,KAAK,EAAE,CAAC;YACR,MAAM,QAAA;SACP;KACF,CAAC,CAAC;AACL,CAAC;AAED,SAAS,kBAAkB,CAAC,KAAK,EAAE,UAAU,EAAE,KAAK;IAC1C,IAAA,MAAM,GAAK,UAAU,OAAf,CAAgB;IAC9B,IAAM,QAAQ,GAAG,KAAK,CAAC,KAAK,CAAC,CAAC,GAAG,KAAK,CAAC,QAAQ,EAAE,GAAG,KAAK,CAAC;IAC1D,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,MAAM,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE;QAC1C,IAAM,OAAO,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC;QAC1B,IAAM,IAAI,GAAG,MAAM,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC;QAC3B,IAAI,QAAQ,IAAI,OAAO,CAAC,CAAC,IAAI,QAAQ,IAAI,IAAI,CAAC,CAAC,EAAE;YAC/C,IAAM,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,GAAG,OAAO,CAAC,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK;YAC5D,IAAM,CAAC,GAAG,OAAO,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,QAAQ,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC;YACjD,OAAO,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC;SACtB;KACF;AACH,CAAC;AAED,SAAS,iBAAiB,CAAC,KAAK,EAAE,CAAC,EAAE,KAAK;IACxC,IAAM,MAAM,GAAG,CAAC,CAAC,GAAG,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,GAAG,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,GAAG,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC;IACnE,OAAO,KAAK,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC;AACzC,CAAC;AAED,MAAM,UAAU,aAAa,CAAC,MAAM;IAClC,QAAQ,GAAG,MAAM,CAAC;AACpB,CAAC;AAED,iBAAiB,CAAC,iBAAiB,EAAE,eAAe,CAAC,CAAC","sourcesContent":["import { registerAnimation } from '../../../dependents';\nimport { clone, isFunction, isNil, deepMix } from '@antv/util';\n\nlet plotInfo;\n\nfunction clipingWithData(shape, animateCfg) {\n  const defaultCfg = {\n    easing: 'easeLinear',\n    duration: 10000,\n  };\n  const animationConfig = deepMix({}, animateCfg, defaultCfg);\n  const geometry = shape.get('element').geometry;\n  geometry.labelsContainer.set('visible', false);\n  /** 动画初始状态 */\n  const index = shape.get('index');\n  const coord = geometry.coordinate;\n  const scales = geometry.scales;\n  const yScale = scales[plotInfo.options.yField];\n  const shapeData = clone(shape.get('origin'));\n  setClip(shape, coord);\n  const clip = shape.get('clipShape');\n  const parent = shape.get('parent');\n  const offsetX = 12;\n  let title = null;\n  const { seriesField } = plotInfo.options;\n  if (seriesField) {\n    title = parent.addShape('text', {\n      attrs: {\n        x: coord.start.x + offsetX,\n        y: 0,\n        text: shapeData.data[0][seriesField],\n        fill: shape.attr('stroke'),\n        fontSize: 12,\n        textAlign: 'start',\n        textBaseline: 'middle',\n      },\n    });\n  }\n  const offsetY = title ? 16 : 0;\n  const marker = parent.addShape('text', {\n    attrs: {\n      x: coord.start.x + offsetX,\n      y: offsetY,\n      text: `test${index}`,\n      fill: shape.attr('stroke'),\n      fontSize: 12,\n      textAlign: 'start',\n      textBaseline: 'middle',\n    },\n  });\n  /** 动画执行之后 */\n  animationConfig.callback = () => {\n    if (shape && !shape.get('destroyed')) {\n      shape.setClip(null);\n      clip.remove();\n      marker.animate(\n        {\n          opacity: 0,\n        },\n        300,\n        () => {\n          marker.remove();\n          if (!isNil(title)) {\n            title.remove();\n          }\n          const labelsContainer = geometry.labelsContainer;\n          if (!labelsContainer.get('visible')) {\n            labelsContainer.set('visible', true);\n          }\n        }\n      );\n    }\n  };\n  /** 执行动画 */\n  /** 准备动画参数 */\n  let delay = animationConfig.delay;\n  if (isFunction(delay)) {\n    delay = animationConfig.delay(index);\n  }\n  let easing = animationConfig.easing;\n  if (isFunction(easing)) {\n    easing = animationConfig.easing(index);\n  }\n  /** 动起来 */\n  clip.animate(\n    {\n      width: coord.getWidth(),\n    },\n    animationConfig.duration,\n    easing,\n    animationConfig.callback,\n    delay\n  );\n  (animationConfig.onFrame = (ratio) => {\n    const position = getPositionByRatio(ratio, shapeData, coord);\n    if (!position) return;\n\n    marker.attr('x', position[0] + offsetX);\n    marker.attr('y', position[1] + offsetY);\n    let yText = getDataByPosition(yScale, position[1], coord);\n\n    // use formatter\n    if (yScale.formatter) {\n      yText = yScale.formatter(yText);\n    }\n\n    marker.attr('text', yText);\n  }),\n    marker.animate(animationConfig.onFrame, {\n      duration: animationConfig.duration,\n      easing,\n      callback: animationConfig.callback,\n      delay,\n    });\n  if (title) {\n    title.animate(\n      {\n        onFrame: (ratio) => {\n          const position = getPositionByRatio(ratio, shapeData, coord);\n          if (!position) return;\n          title.attr('x', position[0] + offsetX);\n          title.attr('y', position[1]);\n        },\n      },\n      animationConfig.duration,\n      easing,\n      animationConfig.callback,\n      delay\n    );\n  }\n}\n\nfunction setClip(shape, coord) {\n  const { start, end, height } = coord;\n  shape.setClip({\n    type: 'rect',\n    attrs: {\n      x: start.x,\n      y: end.y,\n      width: 0,\n      height,\n    },\n  });\n}\n\nfunction getPositionByRatio(ratio, dataPoints, coord) {\n  const { points } = dataPoints;\n  const currentX = coord.start.x + coord.getWidth() * ratio;\n  for (let i = 0; i < points.length - 1; i++) {\n    const current = points[i];\n    const next = points[i + 1];\n    if (currentX >= current.x && currentX <= next.x) {\n      const m = (next.y - current.y) / (next.x - current.x); // 斜率\n      const y = current.y + m * (currentX - current.x);\n      return [currentX, y];\n    }\n  }\n}\n\nfunction getDataByPosition(scale, y, coord) {\n  const yRatio = (y - coord.start.y) / (coord.end.y - coord.start.y);\n  return scale.invert(yRatio).toFixed(2);\n}\n\nexport function getPlotOption(option) {\n  plotInfo = option;\n}\n\nregisterAnimation('clipingWithData', clipingWithData);\n"]}