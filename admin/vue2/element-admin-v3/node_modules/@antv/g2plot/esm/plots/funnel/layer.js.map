{"version":3,"file":"layer.js","sourceRoot":"","sources":["../../../src/plots/funnel/layer.ts"],"names":[],"mappings":"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","sourcesContent":["import { deepMix, contains, isFunction, get, findIndex, isEqual, each, set, isArray, assign } from '@antv/util';\nimport { createDom, modifyCSS } from '@antv/dom-util';\nimport {\n  IGroup,\n  IShape,\n  Element,\n  HtmlTooltipTheme,\n  TooltipCssConst,\n  DEFAULT_ANIMATE_CFG,\n  _ORIGIN,\n} from '../../dependents';\nimport { registerPlotType } from '../../base/global';\nimport { LayerConfig } from '../../base/layer';\nimport ViewLayer, { ViewConfig } from '../../base/view-layer';\nimport { getGeom } from '../../geoms/factory';\nimport { ElementOption, DataItem, LineStyle, TextStyle } from '../../interface/config';\nimport './theme';\nimport './geometry/shape/funnel-basic-rect';\nimport './geometry/shape/funnel-dynamic-rect';\nimport './animation/funnel-scale-in-x';\nimport './animation/funnel-scale-in-y';\nimport { mappingColor, rgb2arr } from '../../util/color';\n\nfunction lerp(a, b, factor) {\n  return (1 - factor) * a + factor * b;\n}\n\nconst G2_GEOM_MAP = {\n  column: 'interval',\n};\n\nconst PLOT_GEOM_MAP = {\n  interval: 'funnel',\n};\n\nexport interface FunnelStyle {\n  [k: string]: any;\n}\n\nexport interface FunnelViewConfig extends ViewConfig {\n  funnelStyle?: FunnelStyle | ((...args: any[]) => FunnelStyle);\n  percentage?: Partial<{\n    visible: boolean;\n    line: Partial<{\n      visible: boolean;\n      style: LineStyle;\n    }>;\n    text: Partial<{\n      visible: boolean;\n      content: string;\n      style: TextStyle;\n    }>;\n    value: Partial<{\n      visible: boolean;\n      style: TextStyle;\n      formatter: (yValueUpper: any, yValueLower: any) => string;\n    }>;\n    offsetX: number;\n    offsetY: number;\n    spacing: number;\n  }>;\n  transpose?: boolean;\n  dynamicHeight?: boolean;\n  compareField?: string;\n  compareText?: Partial<{\n    visible: boolean;\n    offsetX: number;\n    offsetY: number;\n    style: TextStyle;\n  }>;\n}\n\nexport interface FunnelLayerConfig extends FunnelViewConfig, LayerConfig {}\n\nexport default class FunnelLayer<T extends FunnelLayerConfig = FunnelLayerConfig> extends ViewLayer<T> {\n  public static getDefaultOptions(props?: Partial<FunnelViewConfig>): Partial<FunnelViewConfig> {\n    const cfg: Partial<FunnelViewConfig> = {\n      label: {\n        visible: true,\n        adjustColor: true,\n      },\n      percentage: {\n        visible: true,\n        offsetX: props.transpose ? 0 : 40,\n        offsetY: props.transpose ? 40 : 0,\n        spacing: 4,\n        line: {\n          visible: true,\n          style: {\n            lineWidth: 1,\n            stroke: 'rgba(0, 0, 0, 0.15)',\n          },\n        },\n        text: {\n          content: '转化率',\n          style: {\n            fill: 'rgba(0, 0, 0, 0.65)',\n          },\n        },\n        value: {\n          visible: true,\n          style: {\n            fill: 'black',\n          },\n          formatter: (yValueUpper, yValueLower) => `${((100 * yValueLower) / yValueUpper).toFixed(2)}%`,\n        },\n      },\n      tooltip: {\n        visible: true,\n        shared: true,\n        showTitle: false,\n        showCrosshairs: false,\n        showMarkers: false,\n      },\n      animation: deepMix({}, DEFAULT_ANIMATE_CFG, {\n        appear: {\n          duration: 800,\n        },\n      }),\n      dynamicHeight: false,\n      compareText: {\n        visible: true,\n        offsetX: -16,\n        offsetY: -16,\n        style: {\n          fill: 'black',\n        },\n      },\n      legend: {\n        position: 'bottom-center',\n      },\n      interactions: [{ type: 'tooltip' }, { type: 'legend-filter' }],\n    };\n    return deepMix({}, super.getDefaultOptions(), cfg);\n  }\n\n  public readonly type: string = 'funnel';\n  public funnel: any;\n\n  private _animationAppearTimeoutHandler: any;\n  private _shouldResetPercentages: boolean = true;\n  private _shouldResetLabels: boolean = true;\n  private _shouldResetCompareTexts: boolean = true;\n  private _legendsListenerAttached: boolean = false;\n\n  constructor(props: T) {\n    super(props);\n    this.adjustProps(this.options);\n\n    if (props.dynamicHeight) {\n      this._genCustomFieldForDynamicHeight(this.getData());\n    }\n\n    if (props.compareField) {\n      this.options.data = this._reduceDataForCompare(this.getData());\n    }\n  }\n\n  public getColorScale() {\n    const { xField } = this.options;\n    if (xField) {\n      return this.view.getScaleByField(xField);\n    }\n  }\n\n  protected coord() {\n    const props = this.options;\n    const coordConfig = {\n      type: 'rect',\n      actions: props.transpose\n        ? props.dynamicHeight\n          ? [['transpose'], ['scale', 1, -1]]\n          : [['scale', 1, -1]]\n        : props.dynamicHeight\n        ? []\n        : [['transpose'], ['scale', 1, -1]],\n    };\n    // @ts-ignore\n    this.setConfig('coordinate', coordConfig);\n  }\n\n  protected axis(): void {\n    this.setConfig('axes', false);\n  }\n\n  protected adjustFunnel(funnel: ElementOption) {\n    const props = this.options;\n\n    // @ts-ignore\n    funnel.shape = props.dynamicHeight ? 'funnel-dynamic-rect' : 'funnel-basic-rect';\n\n    funnel.color = {\n      fields: [props.xField],\n      values: props.color && (Array.isArray(props.color) ? props.color : [props.color]),\n    };\n\n    if (isFunction(props.funnelStyle)) {\n      // @ts-ignore\n      funnel.style = { callback: props.funnelStyle };\n    } else {\n      // @ts-ignore\n      funnel.style = { cfg: props.funnelStyle };\n    }\n\n    funnel.adjust = [\n      {\n        type: props.dynamicHeight ? 'stack' : 'symmetric',\n      },\n    ];\n  }\n\n  protected tooltip() {\n    const props = this.options;\n\n    if (props.compareField) {\n      deepMix(props.tooltip, {\n        htmlContent: (title, items) => {\n          let clss, el, color, elMarker;\n\n          clss = TooltipCssConst.CONTAINER_CLASS;\n          el = createDom(`<div class=\"${clss}\"></div>`);\n          modifyCSS(el, HtmlTooltipTheme[clss]);\n          const elRoot = el;\n\n          if (title) {\n            clss = TooltipCssConst.TITLE_CLASS;\n            el = createDom(`<div class=\"${clss}\"></div>`);\n            modifyCSS(el, HtmlTooltipTheme[clss]);\n            elRoot.appendChild(el);\n            const elTitle = el;\n\n            clss = TooltipCssConst.MARKER_CLASS;\n            el = createDom(`<span class=\"${clss}\"></span>`);\n            modifyCSS(el, HtmlTooltipTheme[clss]);\n            modifyCSS(el, { width: '10px', height: '10px' });\n            elTitle.appendChild(el);\n            elMarker = el;\n\n            el = createDom(`<span>${title}</span>`);\n            elTitle.appendChild(el);\n          }\n\n          if (items) {\n            clss = TooltipCssConst.LIST_CLASS;\n            el = createDom(`<ul class=\"${clss}\"></ul>`);\n            modifyCSS(el, HtmlTooltipTheme[clss]);\n            elRoot.appendChild(el);\n            const elList = el;\n\n            items\n              .reduce((pairs, item) => {\n                if (!color) {\n                  color = item.color;\n                }\n                const compareValues = get(item, 'point._origin.__compare__.compareValues');\n                const yValues = get(item, 'point._origin.__compare__.yValues');\n                yValues.forEach((yValue, i) => pairs.push([compareValues[i], yValue]));\n                return pairs;\n              }, [])\n              .forEach(([compareValue, yValue], index) => {\n                clss = TooltipCssConst.LIST_ITEM_CLASS;\n                el = createDom(`<li class=\"${clss}\" data-index=${index}></li>`);\n                modifyCSS(el, HtmlTooltipTheme[clss]);\n                elList.appendChild(el);\n                const elListItem = el;\n\n                clss = TooltipCssConst.NAME_CLASS;\n                el = createDom(`<span class=\"${clss}\">${compareValue}</span>`);\n                modifyCSS(el, HtmlTooltipTheme[clss]);\n                elListItem.appendChild(el);\n\n                clss = TooltipCssConst.VALUE_CLASS;\n                el = createDom(`<span class=\"${clss}\">${yValue}</span>`);\n                modifyCSS(el, HtmlTooltipTheme[clss]);\n                elListItem.appendChild(el);\n              });\n          }\n\n          if (color && elMarker) {\n            modifyCSS(elMarker, { backgroundColor: color });\n          }\n\n          return elRoot;\n        },\n      });\n    }\n\n    super.tooltip();\n  }\n\n  protected addGeometry() {\n    const props = this.options;\n    const funnel = getGeom('interval', 'main', {\n      positionFields: [props.dynamicHeight ? '_' : props.xField, props.yField],\n      plot: this,\n    });\n    this.adjustFunnel(funnel);\n    this.funnel = funnel;\n    this.setConfig('geometry', funnel);\n    if (!props.compareField) {\n      this.geometryTooltip();\n    }\n  }\n\n  protected geometryTooltip() {\n    const tooltipOptions = this.options.tooltip;\n    if (tooltipOptions.fields) {\n      if (!this.funnel.tooltip) {\n        this.funnel.tooltip = {};\n      }\n      this.funnel.tooltip.fields = tooltipOptions.fields;\n    }\n    if (tooltipOptions.formatter) {\n      if (!this.funnel.tooltip) {\n        this.funnel.tooltip = {};\n      }\n      this.funnel.tooltip.callback = tooltipOptions.formatter;\n      if (!tooltipOptions.fields) {\n        this.funnel.tooltip.fields = [this.options.xField, this.options.yField];\n      }\n    }\n  }\n\n  protected animation() {\n    super.animation();\n    const props = this.options;\n    if (props.animation === false) {\n      /** 关闭动画 */\n      this.funnel.animate = false;\n    } else {\n      const data = this.getData();\n      const appearDuration = get(props, 'animation.appear.duration');\n      const appearDurationEach = appearDuration / (data.length || 1);\n\n      if (this._animationAppearTimeoutHandler) {\n        clearTimeout(this._animationAppearTimeoutHandler);\n        delete this._animationAppearTimeoutHandler;\n      }\n      this._animationAppearTimeoutHandler = setTimeout(() => {\n        this.fadeInPercentages(appearDurationEach);\n        if (props.compareField) {\n          this.fadeInCompareTexts(appearDurationEach);\n        }\n        delete this._animationAppearTimeoutHandler;\n      }, appearDuration);\n\n      this.funnel.animate = deepMix({}, props.animation, {\n        appear: {\n          animation: props.transpose ? 'funnelScaleInX' : 'funnelScaleInY',\n          duration: appearDurationEach,\n          delay: (datum) => findIndex(data, (o) => isEqual(o, datum)) * appearDurationEach,\n          callback: (shape) => {\n            this.fadeInLabels(shape, 0.5 * appearDurationEach);\n          },\n        },\n        enter: {\n          animation: 'fade-in',\n        },\n      });\n    }\n  }\n\n  public afterRender() {\n    const props = this.options;\n    this.resetLabels();\n    this.resetPercentages();\n    if (props.compareField) {\n      this.resetCompareTexts();\n    }\n\n    if (props.padding == 'auto') {\n      const percentageContainer = this._findPercentageContainer();\n      if (percentageContainer) {\n        this.paddingController.registerPadding(percentageContainer, 'inner', true);\n      }\n      const compareTextContainer = this._findCompareTextContainer();\n      if (compareTextContainer) {\n        this.paddingController.registerPadding(compareTextContainer, 'inner', true);\n      }\n    }\n\n    super.afterRender();\n\n    if (props.animation === false) {\n      this.fadeInLabels();\n      this.fadeInPercentages();\n      if (props.compareField) {\n        this.fadeInCompareTexts();\n      }\n    }\n\n    if (!this._legendsListenerAttached) {\n      this._legendsListenerAttached = true;\n      // @ts-ignore\n      const legendContainer = this.view.getController('legend').container;\n      legendContainer.on('mousedown', this._onLegendContainerMouseDown);\n    }\n  }\n\n  public updateConfig(cfg: Partial<T>): void {\n    cfg = this.adjustProps(cfg);\n    super.updateConfig(cfg);\n    this._legendsListenerAttached = false;\n  }\n\n  public changeData(data: DataItem[]): void {\n    const props = this.options;\n\n    if (props.animation !== false) {\n      this._shouldResetPercentages = false;\n      this._shouldResetLabels = false;\n    }\n\n    if (props.dynamicHeight) {\n      const checkedData = this._findCheckedDataInNewData(data);\n      this._genCustomFieldForDynamicHeight(checkedData);\n    }\n\n    if (props.compareField) {\n      data = this._reduceDataForCompare(data);\n      const checkedData = this._findCheckedDataInNewData(data);\n      this._updateDataForCompare(checkedData);\n    }\n\n    super.changeData(data);\n\n    this.refreshPercentages();\n    this.refreshLabels();\n    if (props.compareField) {\n      this.fadeInCompareTexts();\n    }\n  }\n\n  protected geometryParser(dim, type) {\n    if (dim === 'g2') {\n      return G2_GEOM_MAP[type];\n    }\n    return PLOT_GEOM_MAP[type];\n  }\n\n  protected adjustProps(props: Partial<T>) {\n    if (props.compareField) {\n      props.dynamicHeight = false;\n    }\n\n    if (props.dynamicHeight) {\n      set(props, `meta.${props.yField}.nice`, false);\n      set(props, 'tooltip.shared', false);\n    }\n    return props;\n  }\n\n  protected resetPercentages() {\n    if (!this._shouldResetPercentages) return;\n\n    const props = this.options;\n    const {\n      offsetX,\n      offsetY,\n      spacing,\n      line: percentageLine = {},\n      text: percentageText = {},\n      value: percentageValue = {},\n    } = props.percentage || {};\n\n    const adjustTimestamp = Date.now();\n    const container = this._findPercentageContainer(true);\n\n    this._eachShape((shape, index, datumLower, datumUpper) => {\n      if (index > 0) {\n        const { minX, maxX, maxY, minY } = shape.getBBox();\n        const x1 = props.transpose ? minX : maxX;\n        const y1 = props.transpose ? (props.compareField ? maxY : minY) : minY;\n\n        const { line, text, value } = this._findPercentageMembersInContainerByIndex(container, index, true);\n\n        const eachProcs = [\n          (x, y, line, text, value) => {\n            if (line) {\n              line.attr(\n                deepMix({}, percentageLine.style, {\n                  x1: x,\n                  y1: y,\n                  x2: props.transpose ? x + offsetX : x - offsetX,\n                  y2: props.transpose ? y - offsetY : y + offsetY,\n                  opacity: 0,\n                })\n              );\n              line.set('adjustTimestamp', adjustTimestamp);\n            }\n\n            let textWidth = 0;\n            let valueWidth = 0;\n\n            const textProc = () => {\n              if (text) {\n                text.attr(\n                  deepMix({}, percentageText.style, {\n                    x: props.transpose ? x + offsetX : x - offsetX - spacing - valueWidth - spacing,\n                    y: props.transpose ? y - offsetY - spacing : y + offsetY,\n                    opacity: 0,\n                    text: percentageText.content,\n                    textAlign: props.transpose ? 'left' : 'right',\n                    textBaseline: props.transpose ? 'bottom' : 'middle',\n                  })\n                );\n                text.set('adjustTimestamp', adjustTimestamp);\n                textWidth = text.getBBox().width;\n              }\n            };\n\n            const valueProc = () => {\n              if (value) {\n                value.attr(\n                  deepMix({}, percentageValue.style, {\n                    x: props.transpose ? x + offsetX + textWidth + spacing : x - offsetX - spacing,\n                    y: props.transpose ? y - offsetY - spacing : y + offsetY,\n                    opacity: 0,\n                    text: isFunction(percentageValue.formatter)\n                      ? props.compareField\n                        ? percentageValue.formatter(\n                            get(datumUpper, '__compare__.yValues.0'),\n                            get(datumLower, '__compare__.yValues.0')\n                          )\n                        : percentageValue.formatter(datumUpper[props.yField], datumLower[props.yField])\n                      : '',\n                    textAlign: props.transpose ? 'left' : 'right',\n                    textBaseline: props.transpose ? 'bottom' : 'middle',\n                  })\n                );\n                value.set('adjustTimestamp', adjustTimestamp);\n                valueWidth = value.getBBox().width;\n              }\n            };\n\n            if (props.transpose) {\n              textProc();\n              valueProc();\n            } else {\n              valueProc();\n              textProc();\n            }\n          },\n          (x, y, line, text, value) => {\n            if (line) {\n              line.attr(\n                deepMix({}, percentageLine.style, {\n                  x1: x,\n                  y1: y,\n                  x2: x + offsetX,\n                  y2: props.transpose ? (props.compareField ? y + offsetY : y - offsetY) : y + offsetY,\n                  opacity: 0,\n                })\n              );\n              line.set('adjustTimestamp', adjustTimestamp);\n            }\n\n            let textWidth = 0;\n            if (text) {\n              text.attr(\n                deepMix({}, percentageText.style, {\n                  x: props.transpose ? x + offsetX : x + offsetX + spacing,\n                  y: props.transpose\n                    ? props.compareField\n                      ? y + offsetY + spacing\n                      : y - offsetY - spacing\n                    : y + offsetY,\n                  opacity: 0,\n                  text: percentageText.content,\n                  textAlign: 'left',\n                  textBaseline: props.transpose ? (props.compareField ? 'top' : 'bottom') : 'middle',\n                })\n              );\n              text.set('adjustTimestamp', adjustTimestamp);\n              textWidth = text.getBBox().width;\n            }\n\n            if (value) {\n              value.attr(\n                deepMix({}, percentageValue.style, {\n                  x: props.transpose ? x + offsetX + textWidth + spacing : x + offsetX + spacing + textWidth + spacing,\n                  y: props.transpose\n                    ? props.compareField\n                      ? y + offsetY + spacing\n                      : y - offsetY - spacing\n                    : y + offsetY,\n                  opacity: 0,\n                  text: isFunction(percentageValue.formatter)\n                    ? props.compareField\n                      ? percentageValue.formatter(\n                          get(datumUpper, `__compare__.yValues.1`),\n                          get(datumLower, `__compare__.yValues.1`)\n                        )\n                      : percentageValue.formatter(datumUpper[props.yField], datumLower[props.yField])\n                    : '',\n                  textAlign: 'left',\n                  textBaseline: props.transpose ? (props.compareField ? 'top' : 'bottom') : 'middle',\n                })\n              );\n              value.set('adjustTimestamp', adjustTimestamp);\n            }\n          },\n        ];\n\n        if (props.compareField) {\n          const [x0, y0] = [minX, minY];\n          [\n            [x0, y0],\n            [x1, y1],\n          ].forEach(([x, y], i) => eachProcs[i](x, y, line && line[i], text && text[i], value && value[i]));\n        } else {\n          eachProcs[1](x1, y1, line, text, value);\n        }\n      }\n      datumUpper = datumLower;\n      index++;\n    });\n\n    container.get('children').forEach((child) => {\n      if (child.get('adjustTimestamp') != adjustTimestamp) {\n        child.attr({ opacity: 0 });\n        container.set(child.get('id'), null);\n        setTimeout(() => child.remove(), 0);\n      }\n    });\n  }\n\n  protected fadeInPercentages(duration?, callback?) {\n    const props = this.options;\n    const container = this._findPercentageContainer();\n\n    const eachProc = (i?) => {\n      const lastBBox = { minX: Infinity, maxX: -Infinity, minY: Infinity, maxY: -Infinity };\n      this._eachShape((shape, index) => {\n        const members = this._findPercentageMembersInContainerByIndex(container, index);\n\n        const currBBox = { minX: Infinity, maxX: -Infinity, minY: Infinity, maxY: -Infinity };\n        const eachCalc = (member) => {\n          if (member && member.get('type') == 'text') {\n            const { minX, maxX, minY, maxY } = member.getBBox();\n            if (minX < currBBox.minX) currBBox.minX = minX;\n            if (maxX > currBBox.maxX) currBBox.maxX = maxX;\n            if (minY < currBBox.minY) currBBox.minY = minY;\n            if (maxY > currBBox.maxY) currBBox.maxY = maxY;\n          }\n        };\n        each(members, (member) => (isArray(member) ? eachCalc(member[i]) : eachCalc(member)));\n\n        if (\n          currBBox.minX > lastBBox.maxX ||\n          currBBox.maxX < lastBBox.minX ||\n          currBBox.minY > lastBBox.maxY ||\n          currBBox.maxY < lastBBox.minY\n        ) {\n          const eachShow = (member) => {\n            if (member) {\n              const attrs = {\n                opacity: 1,\n              };\n              duration ? member.animate(attrs, duration) : member.attr(attrs);\n            }\n          };\n          each(members, (member) => (isArray(member) ? eachShow(member[i]) : eachShow(member)));\n          assign(lastBBox, currBBox);\n        }\n      });\n    };\n\n    props.compareField ? [0, 1].forEach(eachProc) : eachProc();\n\n    duration && callback && setTimeout(callback, duration);\n  }\n\n  protected fadeOutPercentages(duration?, callback?) {\n    const container = this._findPercentageContainer();\n\n    this._eachShape((shape, index) => {\n      const members = this._findPercentageMembersInContainerByIndex(container, index);\n\n      const eachProc = (member) => {\n        if (member) {\n          const attrs = {\n            opacity: 0,\n          };\n          duration ? member.animate(attrs, duration) : member.attr(attrs);\n        }\n      };\n      each(members, (member) => (isArray(member) ? member.forEach(eachProc) : eachProc(member)));\n    });\n\n    duration && callback && setTimeout(callback, duration);\n  }\n\n  protected refreshPercentages(callback?) {\n    const props = this.options;\n\n    if (props.animation !== false) {\n      const { fadeOutDuration, fadeInDuration } = this._calcRefreshFadeDurations();\n\n      this._shouldResetPercentages = false;\n      this.fadeOutPercentages(fadeOutDuration, () => {\n        this._shouldResetPercentages = true;\n        this.resetPercentages();\n        this.fadeInPercentages(fadeInDuration, callback);\n      });\n    }\n  }\n\n  private _findPercentageContainer(createIfNotFound: boolean = false): IGroup | undefined {\n    const { middleGroup } = this.view;\n\n    let percentageContainer = middleGroup.get('percentageContainer');\n    if (!percentageContainer && createIfNotFound) {\n      percentageContainer = middleGroup.addGroup();\n      middleGroup.set('percentageContainer', percentageContainer);\n    }\n\n    return percentageContainer;\n  }\n\n  private _findPercentageMembersInContainerByIndex(\n    container: IGroup,\n    index: number,\n    createIfNotFound: boolean = false\n  ) {\n    const props = this.options;\n    const { visible, line: percentageLine = {}, text: percentageText = {}, value: percentageValue = {} } =\n      props.percentage || {};\n\n    const members = {\n      line: undefined,\n      text: undefined,\n      value: undefined,\n    };\n\n    if (visible === false || !container) {\n      return members;\n    }\n\n    if (percentageLine.visible !== false) {\n      const find = (i) => {\n        const lineId = `_percentage-line-${index}-${i}`;\n        let line = container.get(lineId);\n        if (!line && createIfNotFound) {\n          line = container.addShape({ id: lineId, type: 'line', attrs: {} });\n          container.set(lineId, line);\n        }\n        return line;\n      };\n      const line = props.compareField ? [0, 1].map(find) : find(0);\n      members.line = line;\n    }\n\n    if (percentageText.visible !== false) {\n      const find = (i) => {\n        const textId = `_percentage-text-${index}-${i}`;\n        let text = container.get(textId);\n        if (!text && createIfNotFound) {\n          text = container.addShape({ id: textId, type: 'text', attrs: {} });\n          container.set(textId, text);\n        }\n        return text;\n      };\n      const text = props.compareField ? [0, 1].map(find) : find(0);\n      members.text = text;\n    }\n\n    if (percentageValue.visible !== false) {\n      const find = (i) => {\n        const valueId = `_percentage-value-${index}-${i}`;\n        let value = container.get(valueId);\n        if (!value && createIfNotFound) {\n          value = container.addShape({ id: valueId, type: 'text', attrs: {} });\n          container.set(valueId, value);\n        }\n        return value;\n      };\n      const value = props.compareField ? [0, 1].map(find) : find(0);\n      members.value = value;\n    }\n\n    return members;\n  }\n\n  private _calcRefreshFadeDurations() {\n    const props = this.options;\n\n    const updateDuration = get(props, 'animation.update.duration');\n    const enterDuration = get(props, 'animation.enter.duration');\n    const fadeInDuration = Math.min(enterDuration, updateDuration) * 0.6;\n    const fadeOutDuration = Math.max(enterDuration, updateDuration) * 1.2;\n\n    return { fadeInDuration, fadeOutDuration };\n  }\n\n  protected resetLabels() {\n    if (!this._shouldResetLabels) return;\n    const props = this.options;\n    const { xField, yField } = props;\n\n    const adjustTimestamp = Date.now();\n    const { labelsContainer } = this._getGeometry();\n\n    const labelProps = props.label || {};\n    const labelStyle = deepMix(\n      {\n        ...this.theme.label,\n      },\n      props.label.style,\n      {\n        opacity: 0,\n        textAlign: 'center',\n        textBaseline: 'middle',\n      }\n    );\n\n    let datumTop;\n    this._eachShape((shape, index, datum, elementIndex) => {\n      const element: Element = shape.get('element');\n      if (index == 0) {\n        datumTop = datum;\n      }\n\n      const { minX, maxX, minY, maxY } = shape.getBBox();\n      const xValue = datum[xField];\n      const yValue = datum[yField];\n\n      if (labelProps.adjustColor) {\n        labelStyle.fill = this._getAdjustedTextFillByShape(shape);\n      }\n\n      const compare = datum.__compare__;\n      let content;\n      const formatArgs = {\n        [_ORIGIN]: datum,\n        element,\n        elementIndex,\n        mappingDatum: [].concat(element.getModel().mappingData)[0],\n        mappingDatumIndex: 0,\n      };\n      if (labelProps.formatter) {\n        content = labelProps.formatter(xValue, formatArgs, index, yValue, datumTop[yField]);\n      } else {\n        if (compare) {\n          content = [0, 1].map(() => `${yValue}`).join(props.transpose ? '\\n\\n' : '    ');\n        } else {\n          content = `${xValue} ${yValue}`;\n        }\n      }\n      const label = this._findLabelInContainerByIndex(labelsContainer, index, true);\n      const ratio = compare ? compare.yValues[0] / (compare.yValues[0] + compare.yValues[1]) : 0.5;\n      if (label) {\n        label.attr({\n          ...labelStyle,\n          x: lerp(minX, maxX, !props.transpose ? ratio : 0.5),\n          y: lerp(minY, maxY, props.transpose ? ratio : 0.5),\n          text: content,\n        });\n\n        label.set('adjustTimestamp', adjustTimestamp);\n      }\n    });\n\n    labelsContainer.get('children').forEach((label) => {\n      if (label.get('adjustTimestamp') != adjustTimestamp) {\n        label.attr({ opacity: 0 });\n        labelsContainer.set(label.get('id'), null);\n        setTimeout(() => label.remove());\n      }\n    });\n  }\n\n  protected fadeInLabels(targetShape?, duration?, callback?) {\n    const { labelsContainer } = this._getGeometry();\n    this._eachShape((shape, index) => {\n      if (!targetShape || targetShape == shape) {\n        const label = this._findLabelInContainerByIndex(labelsContainer, index);\n        if (label) {\n          const shapeBBox = shape.getBBox();\n          const labelBBox = label.getBBox();\n          if (\n            labelBBox.minX >= shapeBBox.minX &&\n            labelBBox.maxX <= shapeBBox.maxX &&\n            labelBBox.minY >= shapeBBox.minY &&\n            labelBBox.maxY <= shapeBBox.maxY\n          ) {\n            const attrs = {\n              opacity: 1,\n            };\n            duration ? label.animate(attrs, duration) : label.attr(attrs);\n          }\n        }\n      }\n    });\n\n    duration && callback && setTimeout(callback, duration);\n  }\n\n  protected fadeOutLabels(targetShape?, duration?, callback?) {\n    const { labelsContainer } = this._getGeometry();\n    this._eachShape((shape, index) => {\n      if (!targetShape || targetShape == shape) {\n        const label = this._findLabelInContainerByIndex(labelsContainer, index);\n        if (label) {\n          const attrs = {\n            opacity: 0,\n          };\n          duration ? label.animate(attrs, duration) : label.attr(attrs);\n        }\n      }\n    });\n\n    duration && callback && setTimeout(callback, duration);\n  }\n\n  protected refreshLabels(callback?) {\n    const props = this.options;\n\n    if (props.animation !== false) {\n      const { fadeOutDuration, fadeInDuration } = this._calcRefreshFadeDurations();\n\n      this._shouldResetLabels = false;\n      this.fadeOutLabels(null, fadeOutDuration, () => {\n        this._shouldResetLabels = true;\n        this.resetLabels();\n        this.fadeInLabels(null, fadeInDuration, callback);\n      });\n    }\n  }\n\n  private _findLabelInContainerByIndex(container: IGroup, index: number, createIfNotFound: boolean = false) {\n    const props = this.options;\n\n    let label;\n\n    if (props.label?.visible === false) {\n      return label;\n    }\n\n    const labelId = `_label-${index}`;\n    label = container.get(labelId);\n    if (!label && createIfNotFound) {\n      label = container.addShape({\n        id: labelId,\n        type: 'text',\n        attrs: {},\n      });\n      container.set(labelId, label);\n    }\n\n    return label;\n  }\n\n  protected resetCompareTexts() {\n    if (!this._shouldResetCompareTexts) return;\n\n    const props = this.options;\n\n    let shapeParentBBox;\n    let compare;\n    this._eachShape((shape, index, datum) => {\n      if (index == 0) {\n        shapeParentBBox = shape.get('parent').getBBox();\n        compare = get(datum, '__compare__');\n      }\n    });\n\n    if (shapeParentBBox && compare && get(props, 'compareText.visible') !== false) {\n      const container = this._findCompareTextContainer(true);\n      const { yValuesMax, compareValues } = compare;\n      const { minX, maxX, minY, maxY } = shapeParentBBox;\n\n      const compareTexts = container.get('children');\n      [0, 1].forEach((i) => {\n        let compareText = compareTexts[i];\n        if (!compareText) {\n          compareText = container.addShape({ type: 'text' });\n        }\n        compareText.attr(\n          deepMix({}, get(props, 'compareText.style'), {\n            text: props.transpose ? compareValues[i] : i ? `  ${compareValues[i]}` : `${compareValues[i]}  `,\n            x: props.transpose\n              ? minX + get(props, 'compareText.offsetX')\n              : lerp(minX, maxX, yValuesMax[0] / (yValuesMax[0] + yValuesMax[1])),\n            y: props.transpose\n              ? lerp(minY, maxY, yValuesMax[0] / (yValuesMax[0] + yValuesMax[1])) + (i ? 8 : -8)\n              : minY + get(props, 'compareText.offsetY'),\n            opacity: 0,\n            textAlign: props.transpose ? 'right' : i ? 'left' : 'right',\n            textBaseline: props.transpose ? (i ? 'top' : 'bottom') : 'bottom',\n          })\n        );\n      });\n    }\n  }\n\n  protected fadeInCompareTexts(duration?, callback?) {\n    const container = this._findCompareTextContainer();\n    if (container) {\n      const compareTexts = container.get('children');\n      [0, 1].forEach((i) => {\n        const compareText = compareTexts[i];\n\n        if (compareText) {\n          const attrs = {\n            opacity: 1,\n          };\n          duration ? compareText.animate(attrs, duration) : compareText.attr(attrs);\n        }\n      });\n    }\n\n    duration && callback && setTimeout(callback, duration);\n  }\n\n  protected fadeOutCompareTexts(duration?, callback?) {\n    const container = this._findCompareTextContainer();\n    if (container) {\n      const compareTexts = container.get('children');\n      [0, 1].forEach((i) => {\n        const compareText = compareTexts[i];\n\n        if (compareText) {\n          const attrs = {\n            opacity: 0,\n          };\n          duration ? compareText.animate(attrs, duration) : compareText.attr(attrs);\n        }\n      });\n    }\n\n    duration && callback && setTimeout(callback, duration);\n  }\n\n  protected refreshCompareTexts(callback?) {\n    const props = this.options;\n\n    if (props.animation !== false) {\n      const { fadeInDuration, fadeOutDuration } = this._calcRefreshFadeDurations();\n\n      this._shouldResetCompareTexts = false;\n      this.fadeOutCompareTexts(fadeOutDuration, () => {\n        this._shouldResetCompareTexts = true;\n        this.resetCompareTexts();\n        this.fadeInCompareTexts(fadeInDuration, callback);\n      });\n    }\n  }\n\n  private _findCompareTextContainer(createIfNotFound: boolean = false) {\n    const { middleGroup } = this.view;\n\n    let compareTextContainer = middleGroup.get('compareTextContainer');\n    if (!compareTextContainer && createIfNotFound) {\n      compareTextContainer = middleGroup.addGroup();\n      middleGroup.set('compareTextContainer', compareTextContainer);\n    }\n\n    return compareTextContainer;\n  }\n\n  private _eachShape(\n    fn: (shape: IShape | IGroup, index: number, datumLower: any, datumUpper: any, elementIndex: number) => void\n  ) {\n    const data = this._findCheckedData(this.getData());\n    const dataLen = data.length;\n    let index = 0;\n    let datumUpper;\n    this._getGeometry()?.elements.forEach((element, elementIndex) => {\n      const { shape } = element;\n      const datumLower = data[index];\n      if (index < dataLen) {\n        fn(shape, index, datumLower, datumUpper, elementIndex);\n      }\n      datumUpper = datumLower;\n      index++;\n    });\n  }\n\n  private _getGeometry() {\n    return this.view.geometries[0];\n  }\n\n  private _getAdjustedTextFillByShape(shape: IShape | IGroup) {\n    const shapeColor = shape.attr('fill');\n    const shapeOpacity = shape.attr('opacity') ? shape.attr('opacity') : 1;\n    const rgb = rgb2arr(shapeColor);\n    const gray = Math.round(rgb[0] * 0.299 + rgb[1] * 0.587 + rgb[2] * 0.114) / shapeOpacity;\n    const colorBand = [\n      { from: 0, to: 85, color: 'white' },\n      { from: 85, to: 170, color: '#F6F6F6' },\n      { from: 170, to: 255, color: 'black' },\n    ];\n    const reflect = mappingColor(colorBand, gray);\n    return reflect;\n  }\n\n  private _genCustomFieldForDynamicHeight(data: any[]) {\n    const props = this.options;\n\n    const total = data.reduce((total, datum) => total + datum[props.yField], 0);\n\n    let ratioUpper = 1;\n    data.forEach((datum, index) => {\n      const value = datum[props.yField];\n      const share = value / total;\n      const ratioLower = ratioUpper - share;\n\n      datum['__custom__'] = {\n        datumIndex: index,\n        dataLength: data.length,\n        ratioUpper,\n        ratioLower,\n        reverse: props.transpose,\n      };\n\n      ratioUpper = ratioLower;\n    });\n  }\n\n  private _findCheckedDataByMouseDownLegendItem(legendItem: IGroup) {\n    const flags = legendItem\n      .get('parent')\n      .get('children')\n      .map((legendItem) => !legendItem.get('unchecked'));\n\n    const data = this.getData().filter((datum, index) => flags[index]);\n\n    return data;\n  }\n\n  private _findCheckedDataInNewData(newData: any[]) {\n    const props = this.options;\n\n    // @ts-ignore\n    const legendContainer = this.view.getController('legend').container;\n\n    const uncheckedXValues = legendContainer\n      .findAll((shape) => shape.get('name') == 'legend-item')\n      .filter((legendItem) => legendItem.get('unchecked'))\n      .map((legendItem) => legendItem.get('id').replace('-legend-item-', ''));\n\n    const checkedData = newData.filter((datum) => !contains(uncheckedXValues, datum[props.xField]));\n\n    return checkedData;\n  }\n\n  private _findCheckedData(data: any[]) {\n    const props = this.options;\n\n    if (props.legend?.visible) {\n      // @ts-ignore\n      const legendContainer = this.view.getController('legend').container;\n\n      const checkedXValues = legendContainer\n        .findAll((shape) => shape.get('name') == 'legend-item')\n        .filter((legendItem) => !legendItem.get('unchecked'))\n        .map((legendItem) => legendItem.get('id').replace('-legend-item-', ''));\n\n      const checkedData = data.filter((datum) => contains(checkedXValues, datum[props.xField]));\n\n      return checkedData;\n    } else {\n      return this.processData(props.data);\n    }\n  }\n\n  private _reduceDataForCompare(data: any[]) {\n    const props = this.options;\n\n    let compareValueFirstVisited;\n    const yValuesMax = [-Infinity, -Infinity];\n    data = data.reduce((newData, datum) => {\n      const xValue = datum[props.xField];\n      const yValue = datum[props.yField];\n      const compareValue = datum[props.compareField];\n      if (!compareValueFirstVisited) compareValueFirstVisited = compareValue;\n\n      let newDatum = newData.find((newDatum) => newDatum[props.xField] == xValue);\n      if (!newDatum) {\n        newDatum = {\n          [props.xField]: xValue,\n          [props.yField]: 0,\n          ['__compare__']: {\n            compareValues: [],\n            yValues: [],\n            yValuesMax: [],\n            yValuesNext: undefined,\n            transpose: props.transpose,\n          },\n        };\n        newData.push(newDatum);\n      }\n      const idx = compareValue == compareValueFirstVisited ? 0 : 1;\n      newDatum['__compare__'].yValues[idx] = yValue;\n      if (yValuesMax[idx] < yValue) {\n        yValuesMax[idx] = yValue as number;\n      }\n      newDatum['__compare__'].compareValues[idx] = compareValue;\n\n      return newData;\n    }, []);\n\n    data.forEach((datum, index) => {\n      datum[props.yField] = get(datum, '__compare__.yValues', []).reduce((yTotal, yValue) => (yTotal += yValue), 0);\n      set(datum, '__compare__.yValuesMax', yValuesMax);\n      set(datum, '__compare__.yValuesNext', get(data, `${index + 1}.__compare__.yValues`));\n    });\n\n    return data;\n  }\n\n  private _updateDataForCompare(data: any[]) {\n    const yValuesMax = [-Infinity, -Infinity];\n    data.forEach((datum) => {\n      const yValues = get(datum, '__compare__.yValues');\n      [0, 1].forEach((i) => {\n        if (yValues[i] > yValuesMax[i]) {\n          yValuesMax[i] = yValues[i];\n        }\n      });\n    });\n\n    data.forEach((datum, index) => {\n      set(datum, '__compare__.yValuesMax', yValuesMax);\n      set(datum, '__compare__.yValuesNext', get(data, `${index + 1}.__compare__.yValues`));\n    });\n  }\n\n  private _onLegendContainerMouseDown = (e) => {\n    const props = this.options;\n\n    const targetName = e.target.get('name');\n    if (targetName.startsWith('legend-item')) {\n      const legendItem = e.target.get('parent');\n      legendItem.set('unchecked', !legendItem.get('unchecked'));\n\n      this.refreshPercentages();\n      this.refreshLabels();\n\n      if (props.dynamicHeight) {\n        const data = this._findCheckedDataByMouseDownLegendItem(legendItem);\n        this._genCustomFieldForDynamicHeight(data);\n      }\n\n      if (props.compareField) {\n        const data = this._findCheckedDataByMouseDownLegendItem(legendItem);\n        this._updateDataForCompare(data);\n        this.refreshCompareTexts();\n      }\n    }\n  };\n}\n\nregisterPlotType('funnel', FunnelLayer);\n"]}